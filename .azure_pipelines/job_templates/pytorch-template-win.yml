# PyTorch build steps template with Windows images Azure DevOps Instances
#
# This build depends on 2 parameters set as an environment variables in the pipeline:
#   - AZURE_DEVOPS_CLI_PAT: Secret var for authenticating to Azure DevOps
#   - AZURE_STORAGE_KEY: Secret var for authenticating to Azure Storage

parameters:
  name: ''
  pool: ''
  customMatrixes: ''

jobs:
- job: ${{parameters.name}}
  timeoutInMinutes: 600
  strategy:
    matrix:
      ${{ insert }}: ${{parameters.customMatrixes}}
  pool:
    name: ${{ parameters.pool}}

  steps:
  # Delete pytorch_tests repo from previous builds if exists
  - script: if exist "pytorch_tests/" rmdir "pytorch_tests/" /q /s
    displayName: Delete pytorch_tests repo from previous builds if exists

  # Clone PyTorch Tests repository
  - powershell: |
      $env:B64Pat = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes(":$env:ADOTOKEN"))
      git -c http.extraHeader="Authorization: Basic $env:B64Pat" clone $env:AZURE_DEVOPS_pytorch_tests_REPO_URL
      cd pytorch_tests
      git checkout mubal/exp_use_scripts_test_other_prs
    env:
      ADOTOKEN: $(AZURE_DEVOPS_CLI_PAT)
    displayName: Clone PyTorch Tests repo

  # Run PyTorch Unit Tests
  - script: call $(Build.SourcesDirectory)\pytorch_tests\scripts\windows\run.bat
    env:
      ADOTOKEN: $(AZURE_DEVOPS_CLI_PAT)
      AZURE_S_K: $(AZURE_STORAGE_KEY)
    displayName: Run PyTorch Unit Tests
